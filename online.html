<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>iPad è³‡ç”¢ç®¡ç†ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: { primary: '#4f46e5', secondary: '#10b981', danger: '#ef4444' },
          fontFamily: { sans: ['Inter', 'Noto Sans TC', 'sans-serif'] }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
    .card-shadow { box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.06); }
    .scroll-container { max-height: 70vh; overflow-y: auto; }
    .modal-body-scroll { max-height: 80vh; overflow-y: auto; }
    .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.75); display: flex; align-items: center; justify-content: center; z-index: 50; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
    .modal-content { transform: scale(0.95); transition: transform 0.3s ease, opacity 0.3s ease; opacity: 0; }
    .modal-backdrop.modal-open { opacity: 1; pointer-events: auto; }
    .modal-backdrop.modal-open .modal-content { transform: scale(1); opacity: 1; }
    #global-loading { position: fixed; inset: 0; background: rgba(255,255,255,0.9); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen">

  <!-- Loading -->
  <div id="global-loading">
    <svg class="animate-spin h-12 w-12 text-primary mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
    </svg>
    <p class="text-xl font-bold text-gray-700" id="loading-text">ç³»çµ±åˆå§‹åŒ–ä¸­...</p>
  </div>

  <div class="container mx-auto p-4 md:p-8">
    <header class="mb-6 border-b pb-4">
      <div class="flex justify-between items-center flex-wrap gap-2">
        <h1 class="text-3xl font-extrabold text-primary flex items-center">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 16.1A5 5 0 0 1 5.9 20M2 12.05A9 9 0 0 1 9.95 20M2 8V6a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2h-6"></path><line x1="2" y1="20" x2="2.01" y2="20"></line></svg>
          iPad è³‡ç”¢ç®¡ç†å„€è¡¨æ¿
        </h1>
        <div class="flex items-center gap-3">
          <!-- ç™»å…¥ç‹€æ…‹ -->
          <div id="auth-area" class="flex items-center gap-2">
            <button id="login-btn" onclick="doLogin()" class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg text-sm transition flex items-center gap-2">
              <svg class="w-4 h-4" viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
              Google ç™»å…¥
            </button>
            <div id="user-info" class="hidden flex items-center gap-2">
              <img id="user-avatar" class="w-8 h-8 rounded-full" src="" alt="">
              <span id="user-name" class="text-sm font-medium text-gray-700"></span>
              <span id="admin-badge" class="hidden px-2 py-0.5 text-xs font-bold rounded-full bg-primary/10 text-primary">ç®¡ç†å“¡</span>
              <button onclick="doLogout()" class="text-gray-400 hover:text-red-500 text-sm ml-1" title="ç™»å‡º">âœ•</button>
            </div>
          </div>
          <div id="env-badge" class="px-3 py-1 text-xs font-bold rounded-full bg-gray-200 text-gray-600">é€£ç·šä¸­...</div>
        </div>
      </div>
      <p id="system-message" class="text-sm text-red-600 mt-1 h-5"></p>
    </header>

    <!-- é ç±¤å°èˆª -->
    <div class="mb-6 border-b border-gray-200">
      <ul class="flex flex-wrap -mb-px">
        <li class="mr-2">
          <button id="tab-dashboard" onclick="switchView('dashboard')" class="inline-block p-4 border-b-2 border-primary text-primary font-semibold rounded-t-lg transition duration-150">åˆ†ä½ˆæ¦‚è¦½èˆ‡æŸ¥è©¢</button>
        </li>
        <li class="mr-2">
          <button id="tab-carts" onclick="switchView('carts')" class="inline-block p-4 border-b-2 border-transparent text-gray-500 font-semibold rounded-t-lg hover:text-gray-600 transition duration-150">å……é›»è»Šç®¡ç†</button>
        </li>
        <li class="mr-2">
          <button id="tab-edit" onclick="switchView('edit')" class="inline-block p-4 border-b-2 border-transparent text-gray-500 font-semibold rounded-t-lg hover:text-gray-600 transition duration-150">æ•¸æ“šç·¨è¼¯æ¨¡å¼</button>
        </li>
        <li class="mr-2">
          <button id="tab-logs" onclick="switchView('logs')" class="inline-block p-4 border-b-2 border-transparent text-gray-500 font-semibold rounded-t-lg hover:text-gray-600 transition duration-150">ğŸ“‹ æ“ä½œç´€éŒ„</button>
        </li>
      </ul>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div id="content-container">
      <!-- è¦–åœ– 1: å„€è¡¨æ¿ -->
      <div id="dashboard-view" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 bg-white p-6 rounded-xl card-shadow">
          <div class="flex justify-between items-center mb-4 border-b pb-2">
            <h2 class="text-2xl font-semibold text-gray-800">å……é›»è»Šåˆ†ä½ˆæ¦‚è¦½</h2>
            <button onclick="exportToCSV()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-3 rounded-lg text-sm transition">å°å‡º CSV</button>
          </div>
          <div class="mb-6 p-4 bg-primary/10 rounded-lg border border-primary/20">
            <p class="text-sm font-medium text-primary">ç³»çµ±å…§æ‰€æœ‰ iPad ç¸½æ•¸:</p>
            <p id="total-ipad-count" class="text-3xl font-extrabold text-primary mt-1">0</p>
          </div>
          <div id="cart-list" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-4 scroll-container"></div>
        </div>
        <div class="lg:col-span-1 bg-white p-6 rounded-xl card-shadow space-y-6">
          <div>
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 border-b pb-2">iPad æŸ¥è©¢èˆ‡ä½ç½®æ›´æ”¹</h2>
            <div class="space-y-4">
              <input type="text" id="ipad-search-input" placeholder="è¼¸å…¥ç·¨è™Ÿ (ä¾‹: 001 æˆ– 901)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-secondary focus:border-secondary">
              <button id="search-button" class="w-full bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition">æŸ¥è©¢ç›®å‰åœ°é»</button>
              <div id="search-result" class="mt-4 p-4 bg-secondary/10 border-l-4 border-secondary rounded-lg text-gray-800 hidden">
                <p class="font-bold mb-1">æŸ¥è©¢çµæœ:</p>
                <p id="result-ipad-id" class="font-mono text-sm"></p>
                <p id="result-location" class="text-lg font-bold text-secondary"></p>
                <div id="change-location-container" class="mt-3 hidden">
                  <button id="change-location-button" class="w-full bg-primary hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">æ›´æ”¹ä½ç½®</button>
                </div>
              </div>
            </div>
          </div>
          <div>
            <h2 class="text-xl font-semibold mb-2 text-gray-800 border-b pb-2">è³‡æ–™åŒæ­¥æ“ä½œ</h2>
            <button onclick="initializeData()" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition flex items-center justify-center">
              é‡æ–°è¼‰å…¥è³‡æ–™
            </button>
          </div>
        </div>
      </div>

      <!-- è¦–åœ– 2: å……é›»è»Šç®¡ç† -->
      <div id="carts-view" class="hidden space-y-6">
        <div class="bg-white p-6 rounded-xl card-shadow">
          <div class="flex justify-between items-center mb-4 border-b pb-2 flex-wrap gap-2">
            <h2 class="text-2xl font-semibold text-gray-800">ğŸšš å……é›»è»Šæ¬ç§»</h2>
            <button onclick="returnAllCarts()" class="bg-danger hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition">ğŸ  å…¨éƒ¨æ­¸å›å‰µæ„æ•™å®¤</button>
          </div>
          <p class="text-sm text-gray-500 mb-4">é¸æ“‡æ–°åœ°é»å¾ŒæŒ‰ã€Œæ¬ç§»ã€ï¼Œæ•´è»Šæ‰€æœ‰ iPad ç«‹å³åŒæ­¥æ›´æ–°åˆ° Firebase</p>
          
          <!-- å¸¸ç”¨åœ°é»å¿«é¸èªªæ˜ -->
          <div class="mb-4 p-3 bg-gray-50 rounded-lg">
            <p class="text-xs text-gray-500 mb-2">ğŸ’¡ å¸¸ç”¨åœ°é»å¿«é¸ï¼ˆé»æ“Šè‡ªå‹•å¡«å…¥ï¼‰ï¼š</p>
            <div id="quick-locations" class="flex flex-wrap gap-2"></div>
          </div>

          <div id="cart-mgmt-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
        </div>
      </div>

      <!-- è¦–åœ– 3: ç·¨è¼¯è¡¨æ ¼ -->
      <div id="edit-view" class="hidden bg-white p-6 rounded-xl card-shadow">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h2 class="text-2xl font-semibold text-gray-800">æ‰¹é‡ç·¨è¼¯</h2>
          <button onclick="saveAllDataToCloud()" class="bg-primary hover:bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg text-sm transition shadow-lg">å„²å­˜è®Šæ›´åˆ°é›²ç«¯</button>
        </div>
        <div class="mb-4 flex space-x-2">
          <input type="text" id="edit-filter-input" placeholder="ç¯©é¸: è¼¸å…¥å……é›»è»Šåã€åœ°é»æˆ– iPad ç·¨è™Ÿ" class="w-full p-3 border border-gray-300 rounded-lg" oninput="renderEditTable()">
          <button onclick="clearEditFilter()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg transition text-sm flex-shrink-0">æ¸…é™¤</button>
        </div>
        <div class="table-view-container">
          <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0 z-10">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="id">iPad ç·¨è™Ÿ</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="assignedCart">éš¸å±¬å……é›»è»Š</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="currentCart">ç›®å‰å……é›»è»Š (ç·¨è¼¯)</th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sortable-header" data-sort-key="currentLocation">å­˜æ”¾åœ°é» (ç·¨è¼¯)</th>
              </tr>
            </thead>
            <tbody id="edit-table-body" class="bg-white divide-y divide-gray-200"></tbody>
          </table>
        </div>
      </div>
      <!-- è¦–åœ– 4: æ“ä½œç´€éŒ„ -->
      <div id="logs-view" class="hidden bg-white p-6 rounded-xl card-shadow">
        <div class="flex justify-between items-center mb-4 border-b pb-2">
          <h2 class="text-2xl font-semibold text-gray-800">ğŸ“‹ æ“ä½œç´€éŒ„</h2>
          <button onclick="loadLogs()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm transition">é‡æ–°æ•´ç†</button>
        </div>
        <div id="logs-container" class="space-y-2 max-h-[70vh] overflow-y-auto">
          <p class="text-gray-400 text-center py-8">è¼‰å…¥ä¸­...</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Detail Modal -->
  <div id="cart-detail-modal" class="modal-backdrop hidden" onclick="if(event.target===this)closeModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg m-4 modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h3 class="text-2xl font-bold text-gray-800" id="modal-cart-title"></h3>
          <button class="text-gray-400 hover:text-gray-600" onclick="closeModal()">âœ•</button>
        </div>
        <p class="text-lg mb-4 text-gray-600">ç¸½æ•¸: <span id="modal-ipad-count" class="text-primary font-bold"></span> å°</p>
        <div class="modal-body-scroll bg-gray-50 p-4 rounded-lg">
          <div id="modal-ipad-list" class="grid grid-cols-2 gap-2 text-sm font-mono text-gray-700"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Update Location Modal -->
  <div id="update-location-modal" class="modal-backdrop hidden" onclick="if(event.target===this)closeUpdateModal()">
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-md m-4 modal-content">
      <div class="p-6">
        <div class="flex justify-between items-center border-b pb-3 mb-4">
          <h3 class="text-2xl font-bold text-gray-800">æ›´æ”¹ iPad ä½ç½®</h3>
          <button class="text-gray-400 hover:text-gray-600" onclick="closeUpdateModal()">âœ•</button>
        </div>
        <p class="text-lg mb-4 text-gray-600">æ­£åœ¨æ›´æ”¹: <span id="update-ipad-id" class="text-secondary font-bold"></span></p>
        <div class="mb-4 p-3 bg-gray-100 rounded text-sm text-gray-600">
          <span class="font-bold">éš¸å±¬å……é›»è»Š:</span> <span id="display-assigned-cart"></span>
        </div>
        <div class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ–°çš„ç›®å‰å……é›»è»Š:</label>
            <select id="new-current-cart" class="w-full p-3 border border-gray-300 rounded-lg bg-white"></select>
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">æ–°çš„å­˜æ”¾åœ°é»/ç­ç´š:</label>
            <input type="text" id="new-current-location" class="w-full p-3 border border-gray-300 rounded-lg">
          </div>
          <button id="confirm-update-button" class="w-full bg-secondary hover:bg-emerald-600 text-white font-bold py-3 px-4 rounded-lg transition">ç¢ºèªä¸¦æ›´æ–° (åŒæ­¥)</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    // --- Firebase ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, writeBatch, addDoc, query, orderBy, limit as fsLimit, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-firestore.js";
    import { getAuth, signInWithPopup, signOut, onAuthStateChanged, GoogleAuthProvider } from "https://www.gstatic.com/firebasejs/11.4.0/firebase-auth.js";

    const app = initializeApp({
      apiKey: "AIzaSyClniX_uQNPDRC8bTLZP-s3-aGB6466t1c",
      authDomain: "github-f016e.firebaseapp.com",
      projectId: "github-f016e",
      storageBucket: "github-f016e.firebasestorage.app",
      messagingSenderId: "726498300688",
      appId: "1:726498300688:web:903d43c66c35b74e3e05d3"
    });
    const db = getFirestore(app);
    const auth = getAuth(app);
    const COLLECTION = "ipad-assets";
    const LOG_COLLECTION = "ipad-logs";

    // --- ç®¡ç†å“¡ç™½åå–® ---
    const ADMIN_EMAILS = [
      "m72900024@gmail.com"
    ];

    // --- å…¨åŸŸè®Šæ•¸ ---
    let allIpads = [];
    let ipadsMap = {};
    let currentEditingIpadId = null;
    let currentSort = { key: 'id', direction: 'asc' };
    let dirtyIds = new Set();
    let currentUser = null;
    let isAdmin = false;

    // --- æ¬Šé™æª¢æŸ¥ ---
    function checkAdmin() {
      return currentUser && ADMIN_EMAILS.includes(currentUser.email);
    }

    function requireAdmin(actionName) {
      if (!isAdmin) {
        if (!currentUser) {
          showSystemMessage('è«‹å…ˆç™»å…¥ Google å¸³è™Ÿæ‰èƒ½' + actionName, 'error');
        } else {
          showSystemMessage(`å¸³è™Ÿ ${currentUser.email} æ²’æœ‰ç·¨è¼¯æ¬Šé™`, 'error');
        }
        return false;
      }
      return true;
    }

    // --- Google ç™»å…¥/ç™»å‡º ---
    window.doLogin = async function() {
      try {
        await signInWithPopup(auth, new GoogleAuthProvider());
      } catch (e) {
        if (e.code !== 'auth/popup-closed-by-user') {
          showSystemMessage('ç™»å…¥å¤±æ•—: ' + e.message, 'error');
        }
      }
    };

    window.doLogout = async function() {
      await signOut(auth);
    };

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      isAdmin = checkAdmin();
      updateAuthUI();
    });

    function updateAuthUI() {
      const loginBtn = document.getElementById('login-btn');
      const userInfo = document.getElementById('user-info');
      const adminBadge = document.getElementById('admin-badge');

      if (currentUser) {
        loginBtn.classList.add('hidden');
        userInfo.classList.remove('hidden');
        document.getElementById('user-avatar').src = currentUser.photoURL || '';
        document.getElementById('user-name').textContent = currentUser.displayName || currentUser.email;
        if (isAdmin) {
          adminBadge.classList.remove('hidden');
        } else {
          adminBadge.classList.add('hidden');
        }
      } else {
        loginBtn.classList.remove('hidden');
        userInfo.classList.add('hidden');
      }
    }

    // --- æ“ä½œç´€éŒ„ ---
    async function addLog(action, detail) {
      try {
        await addDoc(collection(db, LOG_COLLECTION), {
          action,
          detail,
          user: currentUser?.email || 'æœªçŸ¥',
          userName: currentUser?.displayName || '',
          timestamp: serverTimestamp(),
          localTime: new Date().toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' })
        });
      } catch (e) { console.warn('Log å¯«å…¥å¤±æ•—:', e); }
    }

    async function fetchLogs(count = 50) {
      const q = query(collection(db, LOG_COLLECTION), orderBy('timestamp', 'desc'), fsLimit(count));
      const snap = await getDocs(q);
      return snap.docs.map(d => ({ id: d.id, ...d.data() }));
    }

    // --- Firebase API ---
    async function firebaseGetAll() {
      const snap = await getDocs(collection(db, COLLECTION));
      return snap.docs.map(d => d.data());
    }

    async function firebaseUpdateSingle(ipadId, newCart, newLocation) {
      const ref = doc(db, COLLECTION, ipadId);
      await updateDoc(ref, { currentCart: newCart, currentLocation: newLocation });
    }

    async function firebaseSaveAll() {
      const toSave = dirtyIds.size > 0 ? allIpads.filter(i => dirtyIds.has(i.id)) : allIpads;
      const BATCH_SIZE = 400;
      for (let start = 0; start < toSave.length; start += BATCH_SIZE) {
        const batch = writeBatch(db);
        const chunk = toSave.slice(start, start + BATCH_SIZE);
        for (const item of chunk) {
          batch.set(doc(db, COLLECTION, item.id), item);
        }
        await batch.commit();
      }
      dirtyIds.clear();
      return toSave.length;
    }

    // --- ä¸»é‚è¼¯ ---
    window.initializeData = async function() {
      toggleLoading(true, "æ­£åœ¨å¾ Firebase è¼‰å…¥...");
      try {
        const data = await firebaseGetAll();
        if (data.length === 0) {
          toggleLoading(false);
          const badge = document.getElementById('env-badge');
          badge.textContent = 'âš ï¸ Firestore ç„¡è³‡æ–™';
          badge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-red-100 text-red-700';
          showSystemMessage('Firestore ç„¡è³‡æ–™ï¼Œè«‹å…ˆåŸ·è¡Œ seed.html åŒ¯å…¥', 'error');
          return;
        }
        onDataLoaded(data);
      } catch (e) {
        toggleLoading(false);
        showSystemMessage('Firebase éŒ¯èª¤: ' + e.message, 'error');
      }
    };

    function onDataLoaded(data) {
      allIpads = data;
      ipadsMap = {};
      allIpads.forEach(ipad => ipadsMap[ipad.id.toUpperCase()] = ipad);
      renderCartOverview();
      renderCartManagement();
      renderEditTable();
      toggleLoading(false);
      dirtyIds.clear();
      const badge = document.getElementById('env-badge');
      badge.textContent = 'ğŸ”¥ Firebase ç·šä¸Šæ¨¡å¼';
      badge.className = 'px-3 py-1 text-xs font-bold rounded-full bg-green-100 text-green-700';
      showSystemMessage(`è³‡æ–™åŒæ­¥å®Œæˆï¼Œå…± ${allIpads.length} ç­†`, 'success');
    }

    window.saveAllDataToCloud = async function() {
      if (!requireAdmin('å„²å­˜')) return;
      if (!confirm('ç¢ºå®šè¦å„²å­˜è®Šæ›´å—ï¼Ÿ')) return;
      toggleLoading(true, "æ­£åœ¨å„²å­˜åˆ° Firebase...");
      try {
        const count = await firebaseSaveAll();
        showSystemMessage(`å„²å­˜æˆåŠŸï¼å…±æ›´æ–° ${count} ç­†`, 'success');
      } catch (e) {
        showSystemMessage('å„²å­˜å¤±æ•—: ' + e.message, 'error');
      }
      toggleLoading(false);
    };

    async function updateSingleIpadCloud(ipadId, newCart, newLocation) {
      if (!requireAdmin('æ›´æ–°')) return;
      toggleLoading(true, "æ­£åœ¨æ›´æ–°...");
      try {
        await firebaseUpdateSingle(ipadId, newCart, newLocation);
        await addLog('æ›´æ–°å–®å°', `${ipadId} â†’ ${newCart} / ${newLocation}`);
        const target = allIpads.find(i => i.id.toUpperCase() === ipadId.toUpperCase());
        if (target) {
          target.currentCart = newCart;
          target.currentLocation = newLocation;
          if (ipadsMap[ipadId.toUpperCase()]) {
            Object.assign(ipadsMap[ipadId.toUpperCase()], { currentCart: newCart, currentLocation: newLocation });
          }
          renderCartOverview();
          renderCartManagement();
          renderEditTable();
          simulateSearch(ipadId);
          showSystemMessage(`iPad ${ipadId} æ›´æ–°æˆåŠŸï¼`, 'success');
        }
      } catch (e) {
        showSystemMessage('æ›´æ–°å¤±æ•—: ' + e.message, 'error');
      }
      toggleLoading(false);
      closeModal();
    }

    function getUniqueCarts() {
      const carts = new Set();
      allIpads.forEach(i => { carts.add(i.assignedCart); carts.add(i.currentCart); });
      carts.add("ç¶­ä¿®ä¸­");
      return Array.from(carts).sort((a, b) => {
        const na = parseInt(a.match(/\d+/)?.[0] || 999), nb = parseInt(b.match(/\d+/)?.[0] || 999);
        return na - nb || a.localeCompare(b, 'zh-TW');
      });
    }

    // --- ä»‹é¢æ¸²æŸ“ ---
    function toggleLoading(show, text) {
      const el = document.getElementById('global-loading');
      if (text) document.getElementById('loading-text').textContent = text;
      el.style.display = show ? 'flex' : 'none';
    }

    function showSystemMessage(msg, type) {
      const el = document.getElementById('system-message');
      el.textContent = msg;
      el.className = `text-sm mt-1 h-5 ${type === 'error' ? 'text-red-600' : 'text-secondary'}`;
      setTimeout(() => el.textContent = '', 5000);
    }

    function simulateSearch(queryId) {
      const resultEl = document.getElementById('search-result');
      const changeBtnContainer = document.getElementById('change-location-container');
      resultEl.classList.add('hidden');
      changeBtnContainer.classList.add('hidden');
      if (!queryId) return;
      queryId = queryId.trim();

      let target = ipadsMap[queryId.toUpperCase()];
      if (!target && /^\d+$/.test(queryId)) {
        const padded = String(parseInt(queryId, 10)).padStart(3, '0');
        target = ipadsMap[`YZES_IPAD9_${padded}`] || ipadsMap[`YZES_IPAD10_${padded}`];
      }
      if (!target) {
        target = allIpads.find(i => i.id.toUpperCase().includes(queryId.toUpperCase()));
      }

      const idEl = document.getElementById('result-ipad-id');
      const locEl = document.getElementById('result-location');
      resultEl.classList.remove('hidden', 'bg-red-100', 'border-red-500', 'bg-secondary/10', 'border-secondary');

      if (target) {
        idEl.textContent = `ç·¨è™Ÿ: ${target.id}`;
        locEl.textContent = `ç›®å‰å……é›»è»Š: ${target.currentCart} (å­˜æ”¾æ–¼: ${target.currentLocation})`;
        resultEl.classList.add('bg-secondary/10', 'border-secondary');
        document.getElementById('change-location-button').onclick = () => {
          if (!requireAdmin('æ›´æ”¹ä½ç½®')) return;
          showUpdateModal(target);
        };
        changeBtnContainer.classList.remove('hidden');
      } else {
        idEl.textContent = `æŸ¥è©¢: ${queryId}`;
        locEl.textContent = 'æœªæ‰¾åˆ°';
        resultEl.classList.add('bg-red-100', 'border-red-500');
      }
    }

    function renderCartOverview() {
      const list = document.getElementById('cart-list');
      document.getElementById('total-ipad-count').textContent = allIpads.length;
      list.innerHTML = '';

      const groups = allIpads.reduce((acc, i) => {
        (acc[i.currentCart] = acc[i.currentCart] || []).push(i);
        return acc;
      }, {});

      Object.keys(groups).sort((a, b) => {
        const na = parseInt(a.match(/\d+/)?.[0] || 999), nb = parseInt(b.match(/\d+/)?.[0] || 999);
        return na - nb || a.localeCompare(b, 'zh-TW');
      }).forEach(name => {
        const count = groups[name].length;
        const items = groups[name];
        const locs = [...new Set(items.map(i => i.currentLocation).filter(l => l))];
        const locationDisplay = locs.length === 1 ? locs[0] : (locs.length > 1 ? `${locs[0]} ç­‰ ${locs.length} è™•` : 'æœªæŒ‡å®š');

        const div = document.createElement('div');
        div.className = 'bg-white border border-gray-200 p-4 rounded-xl hover:shadow-lg transition cursor-pointer transform hover:scale-[1.02]';

        const isRepair = name.includes('ç¶­ä¿®');
        const isSpecial = ['å¤–å€Ÿ', 'å‰µæ„', 'åœ–æ›¸é¤¨'].some(k => name.includes(k));
        let iconColor = 'text-primary';
        let iconPath = 'M5 20h14v-2H5v2zm14-8h-2V7h2v5zm-4 0H9V7h6v5zm-6 0H5V7h4v5zm8 2H7v-3h10v3z';
        if (isRepair) { iconColor = 'text-danger'; iconPath = 'M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z'; }
        else if (isSpecial) { iconColor = 'text-secondary'; iconPath = 'M10 20h4V4h-4v16zm-6 0h4V4H4v16zm12 0h4V4h-4v16z'; }

        div.innerHTML = `
          <div class="flex items-center space-x-3 mb-3">
            <svg class="h-6 w-6 ${iconColor} flex-shrink-0" viewBox="0 0 24 24" fill="currentColor"><path d="${iconPath}"/></svg>
            <h3 class="text-lg font-bold text-gray-900 truncate" title="${name}">${name}</h3>
          </div>
          <div class="flex justify-between items-end">
            <div><p class="text-3xl font-extrabold text-primary">${count}</p><p class="text-xs text-gray-500">æ•¸é‡</p></div>
            <div class="text-right max-w-[60%]"><p class="text-lg font-bold text-gray-700 truncate" title="${locs.join(', ')}">${locationDisplay}</p><p class="text-xs text-gray-500">å­˜æ”¾åœ°é»</p></div>
          </div>`;
        div.onclick = () => { closeModal(); document.getElementById('edit-filter-input').value = name; switchView('edit'); };
        div.ondblclick = (e) => { e.stopPropagation(); openCartDetailsModal(name, groups[name]); };
        list.appendChild(div);
      });
    }

    function getKnownLocations() {
      const locs = new Set();
      allIpads.forEach(i => { if (i.currentLocation) locs.add(i.currentLocation); });
      // ç¢ºä¿å¸¸ç”¨åœ°é»åœ¨å‰é¢
      const priority = ['å‰µæ„æ•™å®¤', 'åœ–æ›¸é¤¨', 'æ•™å‹™è™•'];
      const sorted = [...priority.filter(p => locs.has(p) || true), ...Array.from(locs).filter(l => !priority.includes(l)).sort()];
      return [...new Set(sorted)];
    }

    function renderCartManagement() {
      const container = document.getElementById('cart-mgmt-cards');
      container.innerHTML = '';

      // å¸¸ç”¨åœ°é»å¿«é¸æŒ‰éˆ•
      const quickLocs = document.getElementById('quick-locations');
      quickLocs.innerHTML = '';
      getKnownLocations().slice(0, 12).forEach(loc => {
        const btn = document.createElement('button');
        btn.className = 'px-3 py-1 bg-white border border-gray-300 rounded-full text-xs hover:bg-primary hover:text-white transition';
        btn.textContent = loc;
        btn.onclick = () => {
          document.querySelectorAll('.cart-loc-input').forEach(input => {
            if (document.activeElement === input || input.dataset.focused === 'true') input.value = loc;
          });
        };
        quickLocs.appendChild(btn);
      });

      // ä»¥ assignedCart ç‚ºç¾¤çµ„ï¼ˆå……é›»è»Šæœ¬èº«ï¼‰
      const cartNames = [...new Set(allIpads.map(i => i.assignedCart))].sort((a, b) => {
        const na = parseInt(a.match(/\d+/)?.[0] || 999), nb = parseInt(b.match(/\d+/)?.[0] || 999);
        return na - nb || a.localeCompare(b, 'zh-TW');
      });

      cartNames.forEach(cartName => {
        const devices = allIpads.filter(i => i.assignedCart === cartName);
        const locations = [...new Set(devices.map(d => d.currentLocation))];
        const currentLoc = locations.length === 1 ? locations[0] : `${locations[0]} ç­‰ ${locations.length} è™•`;
        const mainLoc = locations[0] || '';

        const card = document.createElement('div');
        card.className = 'bg-white border-2 border-gray-200 p-5 rounded-xl hover:border-primary transition';
        card.innerHTML = `
          <div class="flex justify-between items-start mb-3">
            <div>
              <h3 class="text-lg font-bold text-gray-900">${cartName}</h3>
              <p class="text-sm text-gray-500">${devices.length} å°</p>
            </div>
            <span class="px-2 py-1 text-xs font-bold rounded-full ${locations.length === 1 ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-700'}">
              ${locations.length === 1 ? 'ğŸ“ ' + currentLoc : 'âš ï¸ åˆ†æ•£'}
            </span>
          </div>
          <div class="flex gap-2">
            <input type="text" value="${mainLoc}" placeholder="è¼¸å…¥æ–°åœ°é»" 
              id="loc-input-${cartName}" 
              class="cart-loc-input flex-1 p-2 border border-gray-300 rounded-lg focus:border-primary text-sm"
              onfocus="this.dataset.focused='true'" onblur="setTimeout(()=>this.dataset.focused='false',200)">
            <button onclick="moveCart('${cartName}')" 
              class="bg-primary hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg text-sm transition whitespace-nowrap">
              æ¬ç§» ğŸšš
            </button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // æ¬ç§»æ•´è»Š â€” ç›´æ¥å­˜ Firebase
    window.moveCart = async (cartName) => {
      if (!requireAdmin('æ¬ç§»å……é›»è»Š')) return;
      const input = document.getElementById(`loc-input-${cartName}`);
      const newLoc = input.value.trim();
      if (!newLoc) return showSystemMessage('è«‹è¼¸å…¥æ–°åœ°é»', 'error');

      const devices = allIpads.filter(i => i.assignedCart === cartName);
      if (!confirm(`ç¢ºå®šè¦æŠŠã€${cartName}ã€‘(${devices.length} å°) æ¬åˆ°ã€${newLoc}ã€‘å—ï¼Ÿ`)) return;

      toggleLoading(true, `æ­£åœ¨æ¬ç§» ${cartName}...`);
      try {
        const batch = writeBatch(db);
        devices.forEach(ipad => {
          ipad.currentCart = cartName;
          ipad.currentLocation = newLoc;
          if (ipadsMap[ipad.id.toUpperCase()]) {
            ipadsMap[ipad.id.toUpperCase()].currentCart = cartName;
            ipadsMap[ipad.id.toUpperCase()].currentLocation = newLoc;
          }
          batch.update(doc(db, COLLECTION, ipad.id), { currentCart: cartName, currentLocation: newLoc });
        });
        await batch.commit();
        await addLog('æ¬ç§»å……é›»è»Š', `${cartName} (${devices.length}å°) â†’ ${newLoc}`);
        renderCartOverview();
        renderCartManagement();
        renderEditTable();
        showSystemMessage(`âœ… ${cartName} å·²æ¬åˆ°ã€${newLoc}ã€‘ï¼Œå…± ${devices.length} å°`, 'success');
      } catch (e) {
        showSystemMessage('æ¬ç§»å¤±æ•—: ' + e.message, 'error');
      }
      toggleLoading(false);
    };

    // å…¨éƒ¨æ­¸å›å‰µæ„æ•™å®¤
    window.returnAllCarts = async () => {
      if (!requireAdmin('å…¨éƒ¨æ­¸å›')) return;
      if (!confirm('ç¢ºå®šè¦æŠŠæ‰€æœ‰å……é›»è»Šæ­¸å›ã€å‰µæ„æ•™å®¤ã€‘å—ï¼Ÿ\n\né€™æœƒæ›´æ–°å…¨éƒ¨ ' + allIpads.length + ' å° iPad çš„ä½ç½®ï¼')) return;

      toggleLoading(true, "æ­£åœ¨æ­¸å›æ‰€æœ‰å……é›»è»Š...");
      try {
        const BATCH_SIZE = 400;
        for (let start = 0; start < allIpads.length; start += BATCH_SIZE) {
          const batch = writeBatch(db);
          const chunk = allIpads.slice(start, start + BATCH_SIZE);
          chunk.forEach(ipad => {
            ipad.currentCart = ipad.assignedCart;
            ipad.currentLocation = 'å‰µæ„æ•™å®¤';
            if (ipadsMap[ipad.id.toUpperCase()]) {
              ipadsMap[ipad.id.toUpperCase()].currentCart = ipad.assignedCart;
              ipadsMap[ipad.id.toUpperCase()].currentLocation = 'å‰µæ„æ•™å®¤';
            }
            batch.update(doc(db, COLLECTION, ipad.id), { currentCart: ipad.assignedCart, currentLocation: 'å‰µæ„æ•™å®¤' });
          });
          await batch.commit();
        }
        await addLog('å…¨éƒ¨æ­¸å›', `æ‰€æœ‰å……é›»è»Š (${allIpads.length}å°) â†’ å‰µæ„æ•™å®¤`);
        renderCartOverview();
        renderCartManagement();
        renderEditTable();
        showSystemMessage(`âœ… å…¨éƒ¨ ${allIpads.length} å°å·²æ­¸å›å‰µæ„æ•™å®¤`, 'success');
      } catch (e) {
        showSystemMessage('æ­¸å›å¤±æ•—: ' + e.message, 'error');
      }
      toggleLoading(false);
    };

    window.batchUpdateCart = (cartName) => {
      // legacy fallback
      if (!requireAdmin('æ‰¹é‡æ›´æ–°')) return;
      const input = document.getElementById(`loc-input-${cartName}`);
      const newLoc = input.value.trim();
      if (!newLoc) return showSystemMessage('è«‹è¼¸å…¥å­˜æ”¾åœ°é»', 'error');
      if (!confirm(`ç¢ºå®šè¦å°‡ã€${cartName}ã€‘å…§çš„æ‰€æœ‰ iPad ç§»å‹•åˆ°ã€${newLoc}ã€‘å—ï¼Ÿ`)) return;
      let updatedCount = 0;
      allIpads.forEach(ipad => {
        if (ipad.currentCart === cartName) {
          ipad.currentLocation = newLoc;
          dirtyIds.add(ipad.id);
          if (ipadsMap[ipad.id.toUpperCase()]) ipadsMap[ipad.id.toUpperCase()].currentLocation = newLoc;
          updatedCount++;
        }
      });
      showSystemMessage(`å·²æš«å­˜ ${updatedCount} ç­†æ›´æ–°ï¼Œè«‹é»ã€Œå„²å­˜è®Šæ›´åˆ°é›²ç«¯ã€`, 'secondary');
      renderCartOverview(); renderCartManagement(); renderEditTable();
    };

    function renderEditTable() {
      const tbody = document.getElementById('edit-table-body');
      const filter = document.getElementById('edit-filter-input').value.toLowerCase();
      tbody.innerHTML = '';
      const filtered = allIpads.filter(i => !filter || i.id.toLowerCase().includes(filter) || i.currentCart.toLowerCase().includes(filter) || i.currentLocation.toLowerCase().includes(filter));
      filtered.sort((a, b) => {
        const k = currentSort.key, d = currentSort.direction === 'asc' ? 1 : -1;
        if (k === 'id') { const na = parseInt(a.id.match(/\d+/g)?.slice(-1)[0] || 0), nb = parseInt(b.id.match(/\d+/g)?.slice(-1)[0] || 0); if (na !== nb) return (na - nb) * d; }
        return a[k].localeCompare(b[k], 'zh-TW') * d;
      });
      const uniqueCarts = getUniqueCarts();
      filtered.forEach(i => {
        const row = tbody.insertRow();
        row.className = 'hover:bg-gray-100 transition';
        let optionsHtml = uniqueCarts.map(c => `<option value="${c}" ${c === i.currentCart ? 'selected' : ''}>${c}</option>`).join('');
        if (!uniqueCarts.includes(i.currentCart)) optionsHtml += `<option value="${i.currentCart}" selected>${i.currentCart}</option>`;
        row.innerHTML = `
          <td class="px-6 py-4 text-sm font-medium text-gray-900">${i.id}</td>
          <td class="px-6 py-4 text-sm text-gray-500">${i.assignedCart}</td>
          <td class="px-6 py-1"><select data-id="${i.id}" data-key="currentCart" class="w-full p-2 border border-gray-300 rounded focus:border-primary bg-white">${optionsHtml}</select></td>
          <td class="px-6 py-1"><input type="text" value="${i.currentLocation}" data-id="${i.id}" data-key="currentLocation" class="w-full p-2 border border-gray-300 rounded focus:border-secondary"></td>`;
      });
      tbody.querySelectorAll('input, select').forEach(elm => {
        elm.addEventListener('change', (e) => {
          if (!requireAdmin('ç·¨è¼¯')) { e.target.value = allIpads.find(x => x.id === e.target.dataset.id)?.[e.target.dataset.key] || ''; return; }
          const t = allIpads.find(x => x.id === e.target.dataset.id);
          if (t) {
            t[e.target.dataset.key] = e.target.value.trim();
            dirtyIds.add(t.id);
            if (ipadsMap[t.id.toUpperCase()]) ipadsMap[t.id.toUpperCase()][e.target.dataset.key] = e.target.value.trim();
            if (e.target.dataset.key === 'currentCart') renderCartManagement();
            showSystemMessage(`æš«å­˜: ${t.id}ï¼Œè«‹è¨˜å¾—å„²å­˜`, 'secondary');
          }
        });
      });
    }

    window.loadLogs = async function() {
      const container = document.getElementById('logs-container');
      container.innerHTML = '<p class="text-gray-400 text-center py-4">è¼‰å…¥ä¸­...</p>';
      try {
        const logs = await fetchLogs(100);
        if (logs.length === 0) {
          container.innerHTML = '<p class="text-gray-400 text-center py-8">å°šç„¡æ“ä½œç´€éŒ„</p>';
          return;
        }
        container.innerHTML = logs.map(log => `
          <div class="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
            <div class="flex-shrink-0 w-10 h-10 bg-primary/10 rounded-full flex items-center justify-center text-lg">
              ${log.action.includes('æ¬ç§»') ? 'ğŸšš' : log.action.includes('æ­¸å›') ? 'ğŸ ' : log.action.includes('å–®å°') ? 'ğŸ“±' : 'ğŸ“'}
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start">
                <p class="font-bold text-gray-800">${log.action}</p>
                <p class="text-xs text-gray-400 flex-shrink-0">${log.localTime || ''}</p>
              </div>
              <p class="text-sm text-gray-600">${log.detail}</p>
              <p class="text-xs text-gray-400 mt-1">ğŸ‘¤ ${log.userName || log.user}</p>
            </div>
          </div>
        `).join('');
      } catch (e) {
        container.innerHTML = `<p class="text-red-500 text-center py-4">è¼‰å…¥å¤±æ•—: ${e.message}</p>`;
      }
    };

    window.switchView = function(view) {
      ['dashboard', 'carts', 'edit', 'logs'].forEach(v => {
        const el = document.getElementById(`${v}-view`);
        const btn = document.getElementById(`tab-${v}`);
        if (v === view) { el.classList.remove('hidden'); btn.className = btn.className.replace('border-transparent text-gray-500', 'border-primary text-primary'); }
        else { el.classList.add('hidden'); btn.className = btn.className.replace('border-primary text-primary', 'border-transparent text-gray-500'); }
      });
      if (view === 'edit') renderEditTable();
      if (view === 'carts') renderCartManagement();
      if (view === 'dashboard') renderCartOverview();
      if (view === 'logs') loadLogs();
    };

    function openCartDetailsModal(name, items) {
      document.getElementById('modal-cart-title').textContent = name;
      document.getElementById('modal-ipad-count').textContent = items.length;
      document.getElementById('modal-ipad-list').innerHTML = items.sort((a, b) => a.id.localeCompare(b.id)).map(i =>
        `<div class="p-2 bg-white border rounded flex justify-between"><span class="font-mono">${i.id}</span><span class="text-xs font-bold text-primary">${i.currentLocation}</span></div>`
      ).join('');
      const m = document.getElementById('cart-detail-modal');
      m.classList.remove('hidden');
      setTimeout(() => m.classList.add('modal-open'), 10);
    }

    function showUpdateModal(i) {
      currentEditingIpadId = i.id;
      document.getElementById('update-ipad-id').textContent = i.id;
      document.getElementById('display-assigned-cart').textContent = i.assignedCart;
      document.getElementById('new-current-location').value = i.currentLocation;
      const select = document.getElementById('new-current-cart');
      const uniqueCarts = getUniqueCarts();
      let optionsHtml = uniqueCarts.map(c => `<option value="${c}" ${c === i.currentCart ? 'selected' : ''}>${c}</option>`).join('');
      if (!uniqueCarts.includes(i.currentCart)) optionsHtml += `<option value="${i.currentCart}" selected>${i.currentCart}</option>`;
      select.innerHTML = optionsHtml;
      const m = document.getElementById('update-location-modal');
      m.classList.remove('hidden');
      void m.offsetWidth;
      m.classList.add('modal-open');
    }

    function closeModal() {
      document.querySelectorAll('.modal-backdrop').forEach(m => {
        m.classList.remove('modal-open');
        setTimeout(() => m.classList.add('hidden'), 300);
      });
    }
    window.closeModal = closeModal;
    window.closeUpdateModal = closeModal;
    window.clearEditFilter = () => { document.getElementById('edit-filter-input').value = ''; renderEditTable(); };

    window.exportToCSV = () => {
      if (!allIpads.length) return showSystemMessage('ç„¡è³‡æ–™', 'error');
      const csv = ['ç·¨è™Ÿ,éš¸å±¬,ä½ç½®,åœ°é»', ...allIpads.map(i => `${i.id},${i.assignedCart},${i.currentCart},${i.currentLocation}`)].join('\n');
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob(["\ufeff" + csv], { type: 'text/csv' }));
      a.download = `iPad_Assets_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
    };

    // --- äº‹ä»¶ç¶å®š ---
    window.addEventListener('load', () => initializeData());
    document.getElementById('search-button').addEventListener('click', () => simulateSearch(document.getElementById('ipad-search-input').value));
    document.getElementById('ipad-search-input').addEventListener('keydown', (e) => { if (e.key === 'Enter') simulateSearch(e.target.value); });
    document.querySelectorAll('.sortable-header').forEach(h => h.addEventListener('click', (e) => {
      const k = e.currentTarget.dataset.sortKey;
      currentSort = { key: k, direction: currentSort.key === k && currentSort.direction === 'asc' ? 'desc' : 'asc' };
      renderEditTable();
    }));
    document.getElementById('confirm-update-button').addEventListener('click', () => {
      const c = document.getElementById('new-current-cart').value.trim(), l = document.getElementById('new-current-location').value.trim();
      if (c && l) updateSingleIpadCloud(currentEditingIpadId, c, l);
      else showSystemMessage('æ¬„ä½ä¸å¯ç‚ºç©º', 'error');
    });
  </script>
</body>
</html>
